<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>پیام‌ها — درخواست #<%= orderId %>
    </title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazir&family=Montserrat:wght@400;600;700&display=swap');

        :root {
            --gold: #facc15;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.12);
            --muted: rgba(241, 245, 249, 0.6);
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: 'Vazir', 'Montserrat', system-ui;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: #e6eef8;
        }

        .bg-shape {
            position: absolute;
            border-radius: 50%;
            background: rgba(250, 204, 21, 0.12);
            filter: blur(6px);
            z-index: 0;
            animation: float 16s ease-in-out infinite;
        }

        .bg-shape.s1 {
            width: 160px;
            height: 160px;
            left: 6%;
            top: 12%;
        }

        .bg-shape.s2 {
            width: 220px;
            height: 220px;
            right: 6%;
            bottom: 14%;
            animation-duration: 20s;
        }

        .bg-shape.s3 {
            width: 90px;
            height: 90px;
            left: 22%;
            bottom: 8%;
            animation-duration: 18s;
        }

        @keyframes float {
            0% {
                transform: translateY(0) translateX(0);
            }

            50% {
                transform: translateY(-36px) translateX(24px);
            }

            100% {
                transform: translateY(0) translateX(0);
            }
        }

        .wrap {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: center;
            padding: 3.5rem 1rem;
        }

        .card {
            width: 100%;
            max-width: 1100px;
            border-radius: 1.25rem;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            box-shadow: 0 18px 45px rgba(2, 6, 23, 0.6);
            overflow: hidden;
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 1.25rem;
            padding: 1.25rem;
            align-items: start;
        }

        .msgs {
            max-height: 72vh;
            overflow: auto;
            padding-right: 0.25rem;
        }

        .msg {
            display: block;
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            transition: transform .12s ease, box-shadow .12s ease;
            position: relative;
        }

        .msg:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(2, 6, 23, 0.6);
        }

        .msg.officer {
            border-left: 4px solid rgba(59, 130, 246, 0.85);
        }

        .msg.citizen {
            border-left: 4px solid var(--gold);
        }

        .meta {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            margin-bottom: 0.5rem;
        }

        .sender {
            font-weight: 700;
            color: var(--gold);
        }

        .time {
            font-size: 0.82rem;
            color: var(--muted);
        }

        .text {
            color: #e6eef8;
            line-height: 1.55;
            white-space: pre-wrap;
            margin-bottom: 0.5rem;
        }

        .attachments {
            margin-top: 0.6rem;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            margin-bottom: 0.5rem;
        }

        .attach-link {
            color: #cfe9ff;
            text-decoration: underline;
            font-size: 0.95rem;
            display: inline-flex;
            gap: 0.6rem;
            align-items: center;
        }

        .reply {
            margin-top: 0.7rem;
            padding: 0.7rem;
            border-radius: 0.8rem;
            border-left: 3px solid var(--gold);
            background: rgba(255, 255, 255, 0.01);
            color: #dbeafe;
        }

        .reaction-box {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .reaction-btn {
            padding: 0.25rem 0.6rem;
            border-radius: 0.7rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: transparent;
            cursor: pointer;
            transition: all .12s ease;
            color: var(--muted);
        }

        .reaction-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
        }

        .actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.7rem;
        }

        .icon-btn {
            display: inline-flex;
            gap: 0.5rem;
            align-items: center;
            padding: 0.45rem 0.6rem;
            border-radius: 0.7rem;
            font-size: 0.92rem;
            cursor: pointer;
            background: transparent;
            color: var(--muted);
            border: 1px solid rgba(255, 255, 255, 0.03);
            transition: all .12s ease;
        }

        .icon-btn:hover {
            transform: translateY(-3px);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.08);
        }

        .side {
            padding: 0.6rem;
        }

        .section {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: 0.9rem;
            padding: 0.8rem;
            margin-bottom: 1rem;
        }

        .section h3 {
            color: var(--gold);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        textarea,
        input[type="text"],
        .file-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: #e6eef8;
            padding: 0.9rem;
            border-radius: 0.8rem;
            resize: vertical;
            outline: none;
        }

        input[type="file"] {
            padding: 0.4rem;
        }

        .send-btn {
            background: linear-gradient(90deg, var(--gold), #eab308);
            color: #061224;
            padding: 0.85rem 1rem;
            border-radius: 0.85rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            width: 100%;
        }

        .send-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(234, 179, 8, 0.25);
        }

        .small-muted {
            font-size: 0.86rem;
            color: var(--muted);
        }

        @media(max-width:900px) {
            .card {
                grid-template-columns: 1fr;
                max-width: 95%;
                padding: 1rem;
            }

            .side {
                order: 2;
            }

            .msgs {
                order: 1;
                max-height: 62vh;
            }
        }
    </style>
</head>
<%- include('layouts/header') %>

    <body>
        <div class="bg-shape s1"></div>
        <div class="bg-shape s2"></div>
        <div class="bg-shape s3"></div>

        <div class="wrap">
            <div class="card" role="main" aria-labelledby="msg-title">
                <div class="msgs" aria-live="polite" id="messages-list">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 id="msg-title" class="text-xl font-bold" style="color:var(--gold)">
                                پیام‌ها — درخواست #<%= orderId %>
                            </h2>
                            <div class="small-muted mt-1">گفتگو بین شهروند و افسر مربوط به این درخواست</div>
                        </div>
                        <div class="small-muted">
                            <a href="/dashboard" class="hover:opacity-90"><i
                                    class="fa-solid fa-arrow-right-from-bracket"></i> بازگشت</a>
                        </div>
                    </div>

                    <% if(!messages || messages.length===0){ %>
                        <div class="msg card-empty" style="background:transparent; border:none;">
                            <div class="small-muted text-center">هنوز پیامی ارسال نشده است. شما اولین نفری باشید که پیام
                                می‌فرستد.</div>
                        </div>
                        <% } else { %>
                            <% messages.forEach(function(msg){ const roleClass=(msg.sender_role==='officer'
                                )?'officer':'citizen'; %>
                                <article class="msg <%= roleClass %>" id="msg-<%= msg.id %>">
                                    <div class="meta">
                                        <div class="sender">
                                            <%= msg.sender_name || 'کاربر' %>
                                                <% if(msg.is_pinned){ %><span title="Pinned"
                                                        style="color:#fff;margin-left:8px;"><i
                                                            class="fa-solid fa-thumbtack"></i></span>
                                                    <% } %>
                                        </div>
                                        <div class="small-muted"><small>
                                                <%= msg.is_read ? 'خوانده شده' : 'خوانده نشده' %>
                                            </small></div>
                                        <div class="time">
                                            <%= new Date(msg.created_at).toLocaleString('fa-IR') %>
                                        </div>
                                    </div>

                                    <div class="text"><%- msg.message %></div>

                                    <% if(msg.attachments && msg.attachments.length>0){ %>
                                        <div class="attachments">
                                            <% msg.attachments.forEach(function(file){ %>
                                                <a href="<%= file %>" target="_blank" class="attach-link"><i
                                                        class="fa-solid fa-paperclip"></i>
                                                    <%= file.split('/').pop() %>
                                                </a>
                                                <% }) %>
                                        </div>
                                        <% } %>

                                            <% if(msg.replies && msg.replies.length>0){ %>
                                                <% msg.replies.forEach(function(rep){ %>
                                                    <div class="reply">
                                                        <div class="meta">
                                                            <div class="sender">
                                                                <%= rep.sender_name %>
                                                            </div>
                                                            <div class="time small-muted">
                                                                <%= new Date(rep.created_at).toLocaleString('fa-IR') %>
                                                            </div>
                                                        </div>
                                                        <div class="text"><%- rep.message %></div>
                                                    </div>
                                                    <% }) %>
                                                        <% } %>

                                                            <div class="reaction-box">
                                                                <button class="reaction-btn"
                                                                    onclick="react('<%= msg.id %>','like')">👍 <span
                                                                        id="like-<%= msg.id %>">
                                                                        <%= msg.reactions?.like || 0 %>
                                                                    </span></button>
                                                                <button class="reaction-btn"
                                                                    onclick="react('<%= msg.id %>','dislike')">👎 <span
                                                                        id="dislike-<%= msg.id %>">
                                                                        <%= msg.reactions?.dislike || 0 %>
                                                                    </span></button>
                                                                <button class="reaction-btn"
                                                                    onclick="react('<%= msg.id %>','heart')">❤️ <span
                                                                        id="heart-<%= msg.id %>">
                                                                        <%= msg.reactions?.heart || 0 %>
                                                                    </span></button>
                                                            </div>

                                                            <div class="actions">
                                                                <% if(session && session.user &&
                                                                    (session.user.id===msg.sender_id ||
                                                                    session.user.role==='officer' ||
                                                                    session.user.role==='admin' )){ %>
                                                                    <button class="icon-btn w-full"
                                                                        onclick="openEdit('<%= msg.id %>')"
                                                                        title="ویرایش"><i
                                                                            class="fa-solid fa-pen-to-square"></i>
                                                                        ویرایش</button>
                                                                    <form action="/messages/<%= msg.id %>/delete"
                                                                        method="POST">
                                                                        <button class="icon-btn w-full" type="submit"
                                                                            onclick="return confirm('آیا از حذف این پیام مطمئن هستید؟')"><i
                                                                                class="fa-solid fa-trash"></i>
                                                                            حذف</button>
                                                                    </form>
                                                                    <% } %>
                                                                        <% if(session && session.user &&
                                                                            (session.user.role==='officer'
                                                                            ||session.user.role==='admin' )){ %>
                                                                            <form action="/messages/<%= msg.id %>/pin"
                                                                                method="POST">
                                                                                <button class="icon-btn w-full"
                                                                                    type="submit"><i
                                                                                        class="fa-solid fa-thumbtack"></i>
                                                                                    <%= msg.is_pinned ? 'آن‌پین' :'پین'
                                                                                        %>
                                                                                </button>
                                                                            </form>
                                                                            <% } %>
                                                            </div>

                                                            <div class="reply-form mt-2">
                                                                <form onsubmit="submitReply(event, '<%= msg.id %>')">
                                                                    <textarea name="reply" rows="1"
                                                                        placeholder="پاسخ خود را وارد کنید..."
                                                                        required></textarea>
                                                                    <button type="submit" class="send-btn mt-1">ارسال
                                                                        پاسخ</button>
                                                                </form>
                                                            </div>
                                </article>
                                <% }) %>
                                    <% } %>
                </div>

                <div class="side">
                    <div class="section">
                        <h3>ارسال پیام جدید</h3>
                        <form id="newMessageForm">
                            <textarea name="message" rows="3" placeholder="پیام خود را وارد کنید..."
                                required></textarea>
                            <button type="submit" class="send-btn mt-2">ارسال</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function openEdit(msgId) {
                const msgDiv = document.getElementById('msg-' + msgId);
                const textDiv = msgDiv.querySelector('.text');
                const originalText = textDiv.innerText;
                const textarea = document.createElement('textarea');
                textarea.value = originalText;
                textarea.className = 'w-full p-2 rounded';
                textDiv.replaceWith(textarea);

                const saveBtn = document.createElement('button');
                saveBtn.innerText = 'ذخیره';
                saveBtn.className = 'icon-btn mt-2 w-full';
                saveBtn.onclick = () => {
                    const newText = textarea.value;
                    fetch(`/messages/${msgId}/edit`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: newText })
                    }).then(res => res.json()).then(data => {
                        if (data.success) {
                            textDiv.innerText = newText;
                            textarea.replaceWith(textDiv);
                            saveBtn.remove();
                        }
                    });
                };
                textarea.parentNode.appendChild(saveBtn);
            }

            function react(msgId, type) {
                fetch(`/messages/${msgId}/react`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reaction: type })
                }).then(res => res.json()).then(data => {
                    if (data.success) {
                        document.getElementById('like-' + msgId).innerText = data.reactions.like;
                        document.getElementById('dislike-' + msgId).innerText = data.reactions.dislike;
                        document.getElementById('heart-' + msgId).innerText = data.reactions.heart;
                    }
                });
            }

            function submitReply(e, msgId) {
                e.preventDefault();
                const form = e.target;
                const text = form.querySelector('textarea').value;
                fetch(`/messages/${msgId}/reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reply: text })
                }).then(res => res.json()).then(data => {
                    if (data.success) {
                        const msgDiv = document.getElementById('msg-' + msgId);
                        const replyDiv = document.createElement('div');
                        replyDiv.className = 'reply';
                        replyDiv.innerHTML = `<div class="meta"><div class="sender">${data.reply.sender_name}</div><div class="time small-muted">${new Date(data.reply.created_at).toLocaleString('fa-IR')}</div></div><div class="text">${data.reply.message}</div>`;
                        msgDiv.appendChild(replyDiv);
                        form.reset();
                    }
                });
            }

            document.getElementById('newMessageForm').onsubmit = function (e) {
                e.preventDefault();
                const text = this.querySelector('textarea').value;
                fetch(`/orders/<%= orderId %>/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                }).then(res => res.json()).then(data => {
                    if (data.success) { location.reload(); }
                });
            }
        </script>
        <%- include('layouts/footer') %>

    </body>

</html>